#!/bin/bash

set -o errexit
set -o nounset

set -xv

if [ -d extra_buttons ]; then
    case "$PYTHONPATH" in
        *extra_buttons*)
            echo "PYTHONPATH already contains the needed path..."
            ;;
        *)
            extra_path="$(pwd)"/extra_buttons
            export PYTHONPATH="$PYTHONPATH:$extra_path"
            echo "Added '$extra_path' to PYTHONPATH..."
            ;;
    esac
fi

# override unit testing
override="${1:-}"

check_return_value() {
    if [ "$1" -ne 0 ]; then
        echo "Command did not run succesfully. Please check. Exiting..."
        exit 1
    fi
}

if [ -n "$override" ] && [ "$override" = "override" ]; then
    echo "Not running unit tests..."
else
    # run tests before creating zip
    nosetests2 -x --rednose
    check_return_value $?
fi

# remove asserts from files
while read -r file; do
    sed -i.bak -r 's/assert isinstance/# assert isinstance/' "$file"
done < <(grep -l -F "assert isinstance" extra_buttons/*.py --no-messages)

# set ignore UserWarnings
sed -i.bak -r '
s/^# *warnings/warnings/
s/^# *import +warnings/import warnings/
' extra_buttons/extra_buttons.py

grep -P "^import\s+warnings$" extra_buttons/extra_buttons.py
check_return_value $?
grep -P "^warnings\.simplefilter" extra_buttons/extra_buttons.py
check_return_value $?

zip -r --exclude=*.pyc* --exclude=*__pycache__* ~/Desktop/supplementary_buttons_anki_$(date +%s).zip \
    "Supplementary Buttons Anki.py" \
    extra_buttons/__init__.py \
    extra_buttons/*.py \
    extra_buttons/anki_modules/* \
    extra_buttons/docs/__init__.py \
    extra_buttons/docs/_version.py \
    extra_buttons/docs/doc_start.html \
    extra_buttons/docs/github-markdown.css \
    extra_buttons/heading.py \
    extra_buttons/html2text/* \
    extra_buttons/html2text_overrides.py \
    extra_buttons/icons/* \
    extra_buttons/markdown/* \
    extra_buttons/pygments/* \
    extra_buttons/python_modules/* \

# reinsert asserts and warnings comments
for file in extra_buttons/*.bak; do
    mv -v "$file" "${file%.*}"
done
